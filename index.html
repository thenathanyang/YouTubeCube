<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
		<title>CS 174A: Assignment #1 - Nathan Yang</title>
	</head>

	<body>
		<div class="canvasText">
			<h3><a name="textureGenerator">Texture Generator</a></h3>
			<div class="question">
				<label>Enforce square texture</label>
				<input id="squareTexture" type="checkbox" checked="checked">
			</div>
			<div class="question">
				<label>Calculated Dimensions</label>
				<input id="calculatedWidth" disabled="disabled">
				<input id="calculatedHeight" disabled="disabled">
			</div>
			<div class="question">
				<label>Text</label>
				<textarea id="text">HTML5 ROCKS!</textarea>
			</div>
			<div class="question">
				<label>Text size (px)</label>
				<input id="textSize" value="56">
			</div>
			<div class="question">
				<label>Font Family</label>
				<input id="fontFamily" value="monospace">
			</div>
			<div class="question">
				<label>Text colour</label>
				<input id="textColour" value="#333">
			</div>
			<div class="question">
			<label>Text Alignment</label>
			<select id="textAlignment">
				<option value="left">Left</option>
				<option value="center" selected="selected">Centre</option>
				<option value="right">Right</option>
			</select>
			</div>
			<div class="question">
				<label>Maximum Text Width (px)</label>
				<input id="maxWidth" value="256">
			</div>
			<div class="question">
				<label>Background Colour</label>
				<input id="backgroundColour" value="#FFF">
			</div>
			<input type="button" value="Draw Text" onclick="drawText(); initTexture();">
			<div class="canvasContainer">
				<canvas id="textureCanvas" style="display: none;" width="256" height="256">I'm sorry your browser does not support the HTML5 canvas element.</canvas>
			</div>
			<!-- Texture Generation Script -->
			<script type="text/javascript">
				function getPowerOfTwo(value, pow) {
					var pow = pow || 1;
					while(pow<value) {
						pow *= 2;
					}
					return pow;
				}

				function measureText(ctx, textToMeasure) {
					return ctx.measureText(textToMeasure).width;
				}

				function createMultilineText(ctx, textToWrite, maxWidth, text) {
					textToWrite = textToWrite.replace("\n"," ");
					var currentText = textToWrite;
					var futureText;
					var subWidth = 0;
					var maxLineWidth = 0;
					
					var wordArray = textToWrite.split(" ");
					var wordsInCurrent, wordArrayLength;
					wordsInCurrent = wordArrayLength = wordArray.length;
					
					while (measureText(ctx, currentText) > maxWidth && wordsInCurrent > 1) {
						wordsInCurrent--;
						var linebreak = false;
						
						currentText = futureText = "";
						for(var i = 0; i < wordArrayLength; i++) {
							if (i < wordsInCurrent) {
								currentText += wordArray[i];
								if (i+1 < wordsInCurrent) { currentText += " "; }
							}
							else {
								futureText += wordArray[i];
								if( i+1 < wordArrayLength) { futureText += " "; }
							}
						}
					}
					text.push(currentText);
					maxLineWidth = measureText(ctx, currentText);
					
					if(futureText) {
						subWidth = createMultilineText(ctx, futureText, maxWidth, text);
						if (subWidth > maxLineWidth) { 
							maxLineWidth = subWidth;
						}
					}
					
					return maxLineWidth;
				}

				function drawText() {
					var canvasX, canvasY;
					var textX, textY;

					var text = [];
					var textToWrite = document.getElementById('text').value;
					
					var maxWidth = parseInt(document.getElementById('maxWidth').value, 10);
					
					var squareTexture = document.getElementById('squareTexture').checked;
					
					var textHeight = document.getElementById('textSize').value;
					var textAlignment = document.getElementById('textAlignment').value;
					var textColour = document.getElementById('textColour').value;
					var fontFamily = document.getElementById('fontFamily').value;
					
					var backgroundColour = document.getElementById('backgroundColour').value;
					
					var canvas = document.getElementById('textureCanvas');
					var ctx = canvas.getContext('2d');
					
					ctx.font = textHeight+"px "+fontFamily;
					if (maxWidth && measureText(ctx, textToWrite) > maxWidth ) {
						maxWidth = createMultilineText(ctx, textToWrite, maxWidth, text);
						canvasX = getPowerOfTwo(maxWidth);
					} else {
						text.push(textToWrite);
						canvasX = getPowerOfTwo(ctx.measureText(textToWrite).width);
					}
					canvasY = getPowerOfTwo(textHeight*(text.length+1)); 
					if(squareTexture) {
						(canvasX > canvasY) ? canvasY = canvasX : canvasX = canvasY;
					}
					document.getElementById('calculatedWidth').value = canvasX;
					document.getElementById('calculatedHeight').value = canvasY;

					canvas.width = canvasX;
					canvas.height = canvasY;
					
					switch(textAlignment) {
						case "left":
							textX = 0;
							break;
						case "center":
							textX = canvasX/2;
							break;
						case "right":
							textX = canvasX;
							break;
					}
					textY = canvasY/2;
					
					ctx.fillStyle = backgroundColour;
					ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
					
					ctx.fillStyle = textColour;
					ctx.textAlign = textAlignment;
					
					ctx.textBaseline = 'middle'; // top, middle, bottom
					ctx.font = textHeight+"px "+fontFamily;
					
					var offset = (canvasY - textHeight*(text.length+1)) * 0.5;
					
					for(var i = 0; i < text.length; i++) {
						if(text.length > 1) {
							textY = (i+1)*textHeight + offset;
						}
						ctx.fillText(text[i], textX,  textY);
					}
				}

				drawText();
			</script>
		</div>

		<div class="webglText">
			<canvas id="webglCanvas" style="border: 1px solid #000;" width="500" height="500"></canvas>
			<!-- WebGL Scripts -->
			<script type="text/javascript" src="glMatrix.js"></script>
			<script type="text/javascript" src="webgl-utils.js"></script>
			<script id="shader-fs" type="x-shader/x-fragment">
			    precision mediump float;

			    varying vec2 vTextureCoord;
			    varying vec3 vLightWeighting;

			    uniform sampler2D uSampler;

			    void main(void) {
			        vec4 textureColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
			        gl_FragColor = vec4(textureColor.rgb * vLightWeighting, textureColor.a);
			    }
							</script>
							<script id="shader-vs" type="x-shader/x-vertex">
			    attribute vec3 aVertexPosition;
			    attribute vec3 aVertexNormal;
			    attribute vec2 aTextureCoord;

			    uniform mat4 uMVMatrix;
			    uniform mat4 uPMatrix;
			    uniform mat3 uNMatrix;

			    uniform vec3 uAmbientColor;

			    uniform vec3 uLightingDirection;
			    uniform vec3 uDirectionalColor;

			    uniform bool uUseLighting;

			    varying vec2 vTextureCoord;
			    varying vec3 vLightWeighting;

			    void main(void) {
			        gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
			        vTextureCoord = aTextureCoord;

			        if (!uUseLighting) {
			            vLightWeighting = vec3(1.0, 1.0, 1.0);
			        } else {
			            vec3 transformedNormal = uNMatrix * aVertexNormal;
			            float directionalLightWeighting = max(dot(transformedNormal, uLightingDirection), 0.0);
			            vLightWeighting = uAmbientColor + uDirectionalColor * directionalLightWeighting;
			        }
			    }
			</script>

			<script type="text/javascript" src="cube.js"></script>
		</div>

	</body>
</html>


